angular.module('app').controller('venueAnalyticsCtl',['$scope','$state','$rootScope','Business','$http','BusinessVisitCount','socket','VisitCount',function($scope,$state,$rootScope,Business,$http,BusinessVisitCount,socket,VisitCount){$(".analytics-menu,#analytics-sub-menu").addClass('in slowDown');$(".analytics-menu").html(`<i class="fas fa-chart-line"></i>
            <span  class="nav-label"> &nbsp; Analytics</span> <i class="fas fa-angle-right pull-right"></i>`);$("#analytics-sub-menu li").last().addClass('active-a');toastMsg=(isVaild,msg)=>{if(isVaild)
toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
$scope.isBusinessSelect=!1;if(!$scope.userId)$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email;$scope.userId="";if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}
else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
$scope.getBusinessName=()=>{return $scope.businessDelection};getBusinessDailyHits=(res={},visit={})=>{let _00to01=_01to02=_02to03=_03to04=_04to05=_05to06=_06to07=_07to08=_08to09=_09to010=_10to11=_11to12=_12to13=_13to14=_14to15=_15to16=_16to17=_17to18=_18to19=_19to20=_20to21=_21to22=_22to23=_23to24=0;let _00to01_v=_01to02_v=_02to03_v=_03to04_v=_04to05_v=_05to06_v=_06to07_v=_07to08_v=_08to09_v=_09to010_v=_10to11_v=_11to12_v=_12to13_v=_13to14_v=_14to15_v=_15to16_v=_16to17_v=_17to18_v=_18to19_v=_19to20_v=_20to21_v=_21to22_v=_22to23_v=_23to24_v=0;if(res){_00to01=res._00to01;_01to02=res._01to02;_02to03=res._02to03;_03to04=res._03to04;_04to05=res._04to05;_05to06=res._05to06;_06to07=res._06to07;_08to09=res._08to09;_09to010=res._09to010;_10to11=res._10to11;_11to12=res._11to12;_12to13=res._12to13;_13to14=res._13to14;_14to15=res._14to15;_15to16=res._15to16;_16to17=res._16to17;_17to18=res._17to18;_18to19=res._18to19;_19to20=res._19to20;_20to21=res._20to21;_21to22=res._21to22;_22to23=res._22to23;_23to24=res._23to24}
if(visit){_00to01_v=visit._00to01;_01to02_v=visit._01to02;_02to03_v=visit._02to03;_03to04_v=visit._03to04;_04to05_v=visit._04to05;_05to06_v=visit._05to06;_06to07_v=visit._06to07;_07to08_v=visit._07to08;_08to09_v=visit._08to09;_09to010_v=visit._09to010;_10to11_v=visit._10to11;_11to12_v=visit._11to12;_12to13_v=visit._12to13;_13to14_v=visit._13to14;_14to15_v=visit._14to15;_15to16_v=visit._15to16;_16to17_v=visit._16to17;_17to18_v=visit._17to18;_18to19_v=visit._18to19;_19to20_v=visit._19to20;_20to21_v=visit._20to21;_21to22_v=visit._21to22;_22to23_v=visit._22to23;_23to24_v=visit._23to24}
$scope.dailyBusinessHits={"series":["Hits","Conversions"],"data":[[_00to01,_01to02,_02to03,_03to04,_04to05,_05to06,_06to07,_07to08,_08to09,_09to010,_10to11,_11to12,_12to13,_13to14,_14to15,_15to16,_16to17,_17to18,_18to19,_19to20,_20to21,_21to22,_22to23,_23to24],[_00to01_v,_01to02_v,_02to03_v,_03to04_v,_04to05_v,_05to06_v,_06to07_v,_07to08_v,_08to09_v,_09to010_v,_10to11_v,_11to12_v,_12to13_v,_13to14_v,_14to15_v,_15to16_v,_16to17_v,_17to18_v,_18to19_v,_19to20_v,_20to21_v,_21to22_v,_22to23_v,_23to24_v]],"labels":['00-01AM','01-02AM','02-03AM','03-04AM','04-05AM','05-06AM','06-07AM','07-08AM','08-09AM','09-10AM','10-11AM','11-12PM','12-01PM','01-02PM','02-03PM','03-04PM','04-05PM','05-06PM','06-07PM','07-08PM','08-09PM','09-10PM','10-11PM','11-12AM'],"colours":[{backgroundColor:'rgba(254, 191, 75, 1)',pointBackgroundColor:'rgba(59, 89, 152,1)',borderColor:'rgba(51,51,51,1)',pointBorderColor:'rgba(255,255,255,1)',pointHoverBorderColor:'rgba(255,255,255,1)'}],options:{responsive:!0,legend:{display:!0},hover:{mode:'label'},scales:{xAxes:[{display:!0}],yAxes:[{display:!0,ticks:{beginAtZero:!0,steps:10,stepValue:1,max:300}}]},title:{display:!0,text:'Business Hits per hour'}}}}
getBusinessDailyHits();getBusinessWeeklyHits=(arg=[])=>{let _week_day_0=_week_day_1=_week_day_2=_week_day_3=_week_day_4=_week_day_5=_week_day_6=0;if(arg&&arg.length){arg.forEach(val=>{let day=new Date(val.dateZero);let{_00to01,_01to02,_02to03,_03to04,_04to05,_05to06,_06to07,_07to08,_08to09,_09to010,_10to11,_11to12,_12to13,_13to14,_14to15,_15to16,_16to17,_17to18,_18to19,_19to20,_20to21,_21to22,_22to23,_23to24}=val;let totalCnt=_00to01+_01to02+_02to03+_03to04+_04to05+_05to06+_06to07+_07to08+_08to09+_09to010+_10to11+_11to12+_12to13+_13to14+_14to15+_15to16+_16to17+_17to18+_18to19+_19to20+_20to21+_21to22+_22to23+_23to24;if(day.getDay()==0){_week_day_0=totalCnt}
else if(day.getDay()==1){_week_day_1=totalCnt}
else if(day.getDay()==2){_week_day_2=totalCnt}
else if(day.getDay()==3){_week_day_3=totalCnt}
else if(day.getDay()==4){_week_day_4=totalCnt}
else if(day.getDay()==5){_week_day_5=totalCnt}
else if(day.getDay()==6){_week_day_6=totalCnt}})}
$scope.businessHitsWeekLive={"series":["Hits"],"data":[[_week_day_0,_week_day_1,_week_day_2,_week_day_3,_week_day_4,_week_day_5,_week_day_6]],"labels":['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],"colours":[{backgroundColor:'rgba(254, 191, 75, 1)',pointBackgroundColor:'rgba(59, 89, 152,1)',borderColor:'rgba(51,51,51,1)',pointBorderColor:'rgba(255,255,255,1)',pointHoverBorderColor:'rgba(255,255,255,1)'}],options:{responsive:!0,legend:{display:!0},hover:{mode:'label'},scales:{xAxes:[{display:!0}],yAxes:[{display:!0,ticks:{beginAtZero:!0,steps:100,stepValue:1,max:1600}}]},title:{display:!0,text:'Business Hits per Week'}}}}
getBusinessWeeklyHits();getBusinessMonthlyHits=(arg=[])=>{let monthDayArray=[],monthDayArrayTxt=[],monthstart=parseInt(new moment().startOf('month').format("D")),monthend=parseInt(new moment().endOf("month").format("D"));for(let i=monthstart;i<=monthend;i++){if(arg&&arg.length==0){monthDayArray.push(0)}
else{let val=arg.find((m)=>m.date==i);if(val){let{_00to01,_01to02,_02to03,_03to04,_04to05,_05to06,_06to07,_07to08,_08to09,_09to010,_10to11,_11to12,_12to13,_13to14,_14to15,_15to16,_16to17,_17to18,_18to19,_19to20,_20to21,_21to22,_22to23,_23to24}=val;let totalCnt=_00to01+_01to02+_02to03+_03to04+_04to05+_05to06+_06to07+_07to08+_08to09+_09to010+_10to11+_11to12+_12to13+_13to14+_14to15+_15to16+_16to17+_17to18+_18to19+_19to20+_20to21+_21to22+_22to23+_23to24;monthDayArray.push(totalCnt)}else monthDayArray.push(0)}
if(i==1||i==21||i==31)monthDayArrayTxt.push(`${i}st`);else if(i==2||i==22)monthDayArrayTxt.push(`${i}nd`);else if(i==3||i==23)monthDayArrayTxt.push(`${i}rd`);else monthDayArrayTxt.push(`${i}th`)}
$scope.businessHitsMonthlyLive={"series":["Hits"],"data":[monthDayArray],"labels":monthDayArrayTxt,"colours":[{backgroundColor:'rgba(254, 191, 75, 1)',pointBackgroundColor:'rgba(59, 89, 152,1)',borderColor:'rgba(51,51,51,1)',pointBorderColor:'rgba(255,255,255,1)',pointHoverBorderColor:'rgba(255,255,255,1)'}],options:{responsive:!0,legend:{display:!0},hover:{mode:'label'},scales:{xAxes:[{display:!0}],yAxes:[{display:!0,ticks:{beginAtZero:!0,steps:100,stepValue:1,max:2000}}]},title:{display:!0,text:'Business Hits per month'}}}}
getBusinessMonthlyHits();let yearlyCurrentYear;getBusinessyearlyChart=(arg=[])=>{let _Jan=_Feb=_Mar=_Apr=_May=_Jun=_Jul=_Aug=_Sep=_Oct=_Nov=_Dec=0;for(let i=1;i<=12;i++){let data=arg.filter(m=>m.month==i);data.forEach(val=>{if(val){let{_00to01,_01to02,_02to03,_03to04,_04to05,_05to06,_06to07,_07to08,_08to09,_09to010,_10to11,_11to12,_12to13,_13to14,_14to15,_15to16,_16to17,_17to18,_18to19,_19to20,_20to21,_21to22,_22to23,_23to24}=val;let totalCnt=_00to01+_01to02+_03to04+_04to05+_05to06+_06to07+_07to08+_08to09+_09to010+_10to11+_11to12+_12to13+_13to14+_14to15+_15to16+_16to17+_17to18+_18to19+_19to20+_20to21+_21to22+_22to23+_23to24;if(i==1)_Jan+=totalCnt;if(i==2)_Feb+=totalCnt;if(i==3)_Mar+=totalCnt;if(i==4)_Apr+=totalCnt;if(i==5)_May+=totalCnt;if(i==6)_Jun+=totalCnt;if(i==7)_Jul+=totalCnt;if(i==8)_Aug+=totalCnt;if(i==9)_Sep+=totalCnt;if(i==10)_Oct+=totalCnt;if(i==11)_Nov+=totalCnt;if(i==12)_Dec+=totalCnt}})}
$scope.barYearly={"series":["Hits"],"data":[[_Jan,_Feb,_Mar,_Apr,_May,_Jun,_Jul,_Aug,_Sep,_Oct,_Nov,_Dec]],"labels":["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"colours":[{backgroundColor:'rgba(254, 191, 75, 1)',pointBackgroundColor:'rgba(59, 89, 152,1)',borderColor:'rgba(51,51,51,1)',pointBorderColor:'rgba(255,255,255,1)',pointHoverBorderColor:'rgba(255,255,255,1)'}],options:{responsive:!0,legend:{display:!0},hover:{mode:'label'},scales:{xAxes:[{display:!0}],yAxes:[{display:!0,ticks:{beginAtZero:!0,steps:100,stepValue:1,max:6000}}]},title:{display:!0,text:'Business Hits per Year'}}}}
getBusinessyearlyChart();getBusinessHitsFromModel=()=>{let newdate=new Date();BusinessVisitCount.findOne({filter:{where:{ownerId:$scope.userId,date:("0"+newdate.getDate()).slice(-2),month:("0"+(newdate.getMonth()+1)).slice(-2),year:newdate.getFullYear()}}}).$promise.then((res)=>{VisitCount.findOne({filter:{where:{ownerId:$scope.userId,date:("0"+newdate.getDate()).slice(-2),month:("0"+(newdate.getMonth()+1)).slice(-2),year:newdate.getFullYear()}}}).$promise.then((visitRes)=>{getBusinessDailyHits(res,visitRes)})});const from_date=moment().startOf('week');const to_date=moment().endOf('week');var weekStart=new Date(from_date),weekend=new Date(to_date);let dateZeroStart=`${weekStart.getFullYear()}-${("0" + (weekStart.getMonth() + 1)).slice(-2)}-${("0" + weekStart.getDate()).slice(-2)}T00:00:00.000Z`,dateZeroEnd=`${weekend.getFullYear()}-${("0" + (weekend.getMonth() + 1)).slice(-2)}-${("0" + weekend.getDate()).slice(-2)}T00:00:00.000Z`;BusinessVisitCount.find({filter:{where:{ownerId:$scope.userId,dateZero:{between:[dateZeroStart,dateZeroEnd]}}}}).$promise.then((res)=>{if(res&&res.length){getBusinessWeeklyHits(res)}else getBusinessWeeklyHits()});let currentMonth=moment(new Date()).format("MMMM"),currentYear=moment(new Date()).format("YYYY"),monthstart=new moment().startOf('month').format("D"),monthend=new moment().endOf("month").format("D"),currentMonthIndex=moment(new Date()).format("M");currentYear=parseInt(currentYear);currentMonthIndex=parseInt(currentMonthIndex);monthstart=parseInt(monthstart);monthend=parseInt(monthend);BusinessVisitCount.find({filter:{where:{ownerId:$scope.userId,year:{eq:currentYear},month:{eq:currentMonthIndex},date:{between:[monthstart,monthend]}}}}).$promise.then((res)=>{if(res&&res.length){getBusinessMonthlyHits(res)}else getBusinessMonthlyHits([])});BusinessVisitCount.find({filter:{where:{ownerId:$scope.userId,year:currentYear}}}).$promise.then((res)=>{if(res&&res.length){getBusinessyearlyChart(res)}else getBusinessyearlyChart()})}
$scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg&&arg=='analytics'&&$("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg}
getBusinessHitsFromModel()}else $("#businessErr").text('Please select the Business name')}}])