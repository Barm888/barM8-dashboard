angular.module('app').controller('eprofile',['$scope','Business','$rootScope','$http','$stateParams','loader',function($scope,Business,$rootScope,$http,$stateParams,loader){$scope.dropDownShow=!0;$('html, body').css('overflow-y','visible');$('html, body').css('overflow-x','unset');function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
byteString=atob(dataURI.split(',')[1]);else byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
return new Blob([ia],{type:mimeString})}
$scope.imageDetails={};$scope.getFilenameandType=(arg,e)=>{if(e.data('name')=="Profile"){$scope.imageDetails.profileImage='';$scope.imageDetails.profileImage=arg}}
$scope.profileImage=[];$scope.imageconverttofile=(data)=>{$('#imageCropModal').modal('hide');if($(".action #btnCrop").data('name')==="Profile"){$scope.profileImage=[];$("#upload__btn__wrap1").html('');$(".container .imageBox").css('background-image','');$("#upload__btn__wrap1").append(`<img src=${data} style="height: 150px;margin-top: -21px;margin-left: -23px;object-fit: cover;" />`);$scope.profileImage.push(dataURItoBlob(data))}}
$scope.isTrue=!0;if($stateParams.id!=""||$stateParams.id!=null||$stateParams.id!=undefined){$scope.isTrue=!1}
$scope.useremail=$rootScope.currentUser.email;$scope.business={};$scope.isApproveBtn=!1;$scope.userId="";$scope.parentBusinessName=null;function userGet(){if($rootScope.currentUser.email=="admin@barm8.com.au"){Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessSelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify(err))})}
else{$scope.userId=$rootScope.currentUser.id;Business.find({filter:{where:{id:$scope.userId}}}).$promise.then(function(res){$scope.business=res[0];$scope.parentBusinessName=$scope.business.email;if(!res[0].location){$scope.business.location={};$scope.business.location.lat="";$scope.business.location.lng=""}},function(err){$("#msgTxt").text("Please Try again!.");$("#msgShow").modal('show')})}}
userGet();if(!$scope.userId){$scope.userId=$rootScope.currentUser.id;if($scope.isTrue){Business.findOne({filter:{where:{id:$scope.userId}}}).$promise.then(function(res){$scope.business={};$scope.business=res;if(!res.location){$scope.business.location={};$scope.business.location.lat="";$scope.business.location.lng=""}},function(err){toastr.success('Please Try again!.');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}})}}
$scope.getBusinessName=()=>{return $scope.businessSelection}
$scope.BusinessSelected=(arg)=>{if(arg=='Profile'){arg=$("#autocompleteBusiness").data('id');if($(".submitBtnProfile").hasClass('businessSubmit')){$(".submitBtnProfile").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset');$(".submitBtnProfile").removeClass('businessSubmit').addClass('businessReset')}}
$("#location").val('');$scope.userId=arg;Business.findOne({filter:{where:{id:arg}}}).$promise.then(function(res){$scope.userId=arg;$scope.business={};$scope.business=res;if(!res.location){$scope.business.location={};$scope.business.location.lat="";$scope.business.location.lng=""}},function(err){toastr.success('Please Try again!.');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}})};if($stateParams){if($stateParams.id){$scope.dropDownShow=!1;$scope.BusinessSelected($stateParams.id);$scope.isApproveBtn=!0}}
$scope.approveBusiness=function(){let status=$("#approve-notapprove-btn").data('status');console.log(status);if(status=='approved')status='pending';else if(status=='pending')status='approved';loader.visible();Business.upsertWithWhere({where:{"id":$stateParams.id}},{status},(err,res)=>{Business.sendApprovedInfoToEmail({"email":res.email,"qrCode":res.qrCode,"businessName":res.businessName,"qrImageUrl":res.qrImageUrl});loader.hidden();$scope.BusinessSelected($stateParams.id)})};$scope.imgDelete=(id,userid,imgUrl)=>{console.log($stateParams.id);var img=imgUrl.split('/')[2];try{$http.post('/spaceFileDelete',{fileName:img}).then(function(res){console.log(res)},(err)=>{console.log(err)})}catch(err){console.log(err)}
loader.visible();$scope.business={};$scope.business.ownerId=$stateParams.id;$scope.business.imageUrl="";Business.upsertWithWhere({where:{id:$stateParams.id}},{imageUrl:""}).$promise.then((res)=>{toastr.success('Successfully updated!');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"};loader.hidden();Business.findOne({filter:{where:{id:$stateParams.id}}}).$promise.then((businessRes)=>{$scope.business={};$scope.business=businessRes})},(err)=>{loader.hidden();if(err&&err.data&&err.data.error&&err.data.error.statusCode&&err.data.error.statusCode=='422'){toastr.error('Email already exits. Please try again!');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}})};$scope.addressUpdate=(arg,lat,lng,address)=>{$scope.business.location={"lat":$("#lat").val().toString(),"lng":$("#lng").val().toString()};if(address!="")$scope.business.addressLine1=address;for(var i=0;i<arg.length;i++){if(arg[i].types[0]=="administrative_area_level_2"){if(arg[i].long_name==""){$scope.business.city=""}else{$scope.business.city=arg[i].long_name}}
if(arg[i].types[0]=="administrative_area_level_1"){if(arg[i].long_name==""){$scope.business.state=""}else{$scope.business.state=arg[i].long_name}}
if(arg[i].types[0]=="country"){if(arg[i].long_name==""){$scope.business.country=""}else{$scope.business.country=arg[i].long_name}}
if(arg[i].types[0]=="postal_code"){if(arg[i].long_name==""){$scope.business.zipCode=""}else{$scope.business.zipCode=arg[i].long_name}}}};$scope.business={};$scope.updateProfile=()=>{$scope.business={};$scope.business.businessName=$("#venuename").val();$scope.business.abn=$("#abn").val();$scope.business.addressLine1=$("#address1").val();$scope.business.addressLine2=$("#address2").val();$scope.business.suburb=$("#suburb").val();$scope.business.zipCode=$("#postal_code").val();$scope.business.state=$("#state").val();$scope.business.country=$("#country option:selected").text();$scope.business.phone=$("#phone").val();$scope.business.landline=$("#landline").val();$scope.business.website=$("#website").val();$scope.business.venueInformation=$("#venueInformation").val();$scope.business.contact1=$("#contact1").val();$scope.business.contact2=$("#contact2").val();$scope.business.email=$("#inputEmail").val();$scope.business.eddystoneNameSpaceId=$("#eddystoneNameSpaceId").val();$scope.business.eddystoneInstanceId=$("#eddystoneInstanceId").val();$scope.business.eddystoneUrl=$("#eddystoneUrl").val();$scope.business.iBeaconId=$("#iBeaconId").val();$scope.business.majorId=$("#majorId").val();$scope.business.minorId=$("#minorId").val();$scope.business.location={"lat":$("#lat").val().toString(),"lng":$("#lng").val().toString()};updateProfile=()=>{$scope.business.ownerId=$stateParams.id;Business.updateBusinessAttributes({params:$scope.business}).$promise.then((res)=>{toastr.success('Successfully updated!');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"};loader.hidden();Business.findOne({filter:{where:{id:$stateParams.id}}}).$promise.then((businessRes)=>{$scope.business={};$scope.business=businessRes})},(err)=>{loader.hidden();if(err&&err.data&&err.data.error&&err.data.error.statusCode&&err.data.error.statusCode=='422'){toastr.error('Email already exits. Please try again!');toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}})}
if($scope.profileImage.length!=0){var fd1=new FormData();fd1.append(`file${1}`,$scope.profileImage[0],$scope.imageDetails.profileImage);loader.visible();$http.post('/uploadPremium',fd1,{headers:{'Content-Type':undefined}}).then(function(res){$scope.business.imageUrl="/uploads/"+$scope.imageDetails.profileImage;delete $scope.business.password;updateProfile()})}
else{delete $scope.business.password;loader.visible();updateProfile()}}}])