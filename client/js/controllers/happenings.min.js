angular.module('app').controller('happeningsCtl',['$scope','$state','Business','$http','$rootScope','HappeningsCategory','loader','Happenings','$stateParams','HappeningsTicket',function($scope,$state,Business,$http,$rootScope,HappeningsCategory,loader,Happenings,$stateParams,HappeningsTicket){if($rootScope.currentUser&&$rootScope.currentUser.email){$scope.useremail=$rootScope.currentUser.email}else $state.go('logout');toastMsg=(isVaild,msg)=>{if(isVaild)toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
$scope.createNewTicket=()=>{$("#create-tickets").css('display','none');$("#create-new-tickets").css('display','block')}
const convertTime12to24=(time12h)=>{const[time,modifier]=time12h.split(' ');let[hours,minutes]=time.split(':');if(hours==='12'){hours='00'}
if(modifier==='PM'){hours=parseInt(hours,10)+12}
return `${hours}:${minutes}`}
function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
byteString=atob(dataURI.split(',')[1]);else byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
return new Blob([ia],{type:mimeString})};$scope.isBusinessSelect=!1;if(!$scope.userId)$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email;$scope.userId="";if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;if($rootScope.selectedVenue){Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res});$scope.userId=$rootScope.selectedVenue.venueId;$("#autocompleteBusiness").val($rootScope.selectedVenue.venueName);$("#autocompleteBusiness").data('id',$rootScope.selectedVenue.venueId);$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}else{Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}}
else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
$scope.getBusinessName=()=>{return $scope.businessDelection};$scope.happeningsCategory=[];$scope.getHappeningscategory=()=>{HappeningsCategory.find({filter:{where:{ownerId:$scope.userId}}}).$promise.then((res)=>{$scope.happeningsCategory=res.filter(m=>m._name!='Add_New');$scope.happeningsCategory.push(res.find(m=>m._name=='Add_New'))})}
$scope.getHappeningscategory();$scope.getAllTickets=()=>{Happenings.find({filter:{where:{ownerId:$scope.userId},include:[{relation:"happeningsDates",scope:{include:[{relation:"happeningsTickets"}]}}]}},(res)=>{$scope.ticketList=[];if(res&&res.length>=1){$("#create-tickets,#ticket-list").css('display','block');$("#create-new-tickets,#no-img-div").css('display','none');res.filter(m=>{if(m.happeningsDates&&m.happeningsDates){m.happeningsDates.filter(n=>{if(n.happeningsTickets&&n.happeningsTickets.length){n.happeningsTickets.forEach(val=>{$scope.ticketList.push(val)})}})}})}else{$("#ticket-list,#create-new-tickets").css('display','none');$("#create-tickets,#no-img-div").css('display','block')}})}
$scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg){if(arg=='manageEvent'){if($("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg;$scope.getHappeningscategory();$scope.getAllTickets();$rootScope.selectedVenue={venueId:$scope.userId,venueName:$("#autocompleteBusiness").val()}}}else $("#businessErr").text('Please select the Business name')}}}
$scope.imageDetails={};$scope.getFilenameandType=(arg,e)=>{if(e.data('name')=="happenings"){$scope.imageDetails.ImageAddCrop='';$scope.imageDetails.ImageAddCrop=Math.random().toString(36).substring(2)+"_"+arg.replace(/ /g,"_")}};$scope.happeningsImage=[];$scope.imageconverttofile=(data)=>{$('#imageCropModal').modal('hide');if($(".action #btnCrop").data('name')==="happenings"){$scope.happeningsImage=[];$("#upload__btn__wrap_Happenings").html('');$(".container .imageBox").css('background-image','');$("#upload__btn__wrap_Happenings").append(`<img src=${data} style="height: 105px;margin-top: -21px;margin-left: -21px;object-fit: cover;" />`);$scope.happeningsImage.push({imgBlop:dataURItoBlob(data),imgName:$scope.imageDetails.ImageAddCrop})}};$scope.happenings_category={};$scope.happingsChange=(event)=>{if(event._name=='Add_New')$('#addNewcategoryEntertain').modal({backdrop:'static',keyboard:!1});$scope.happenings_category=event};$scope.happeningsSaveBtn=()=>{let name=$("#entertainment_add_new_category").val(),ownerId=$scope.userId;$("#category_enter_err").html('');if($scope.userId&&name){let _name=($.trim(name)).toLowerCase();HappeningsCategory.upsertWithWhere({where:{ownerId,name,_name}},{ownerId,name,_name}).$promise.then(()=>{$scope.getHappeningscategory()});$('#addNewcategoryEntertain').modal('hide');toastMsg(!0,"Successfully created!")}else if(!name)$("#category_enter_err").html('Please enter the category!')};$scope.happeningsDateList=[];$scope.happeningsDateAdd=()=>{$("#happen-start-time-err,#happen-end-time-err,#happen-regis-time-err").css({display:'none'});if($("#events_start_time").val()&&$("#events_end_time").val()&&$("#datepicker_happen").val()){let convert_date=$("#datepicker_happen").val().split('-');let date=`${convert_date[2]}-${convert_date[1]}-${convert_date[0]}`,cdate=new Date(`${$("#datepicker_happen").val()}`),dateNo=((cdate.getDate())>=10)?(cdate.getDate()):'0'+(cdate.getDate()),month=((cdate.getMonth()+1)>=10)?(cdate.getMonth()+1):'0'+(cdate.getMonth()+1),year=cdate.getFullYear();let startTime_24=convertTime12to24(`${$("#events_start_time").val()}`),endTime_24=convertTime12to24(`${$("#events_end_time").val()}`);let happeningsDates={date,dateNo,month,year,startTime:$("#events_start_time").val(),endTime:$("#events_end_time").val(),startDateUTC:(new Date(`${$("#datepicker_happen").val()} ${startTime_24}:00`)).toISOString(),endDateUTC:(new Date(`${$("#datepicker_happen").val()} ${endTime_24}:00`)).toISOString(),dateFormat:`${year}-${month}-${dateNo}T00:00:00.000Z`,registrationTime:$("#events_regis_time").val(),registration_24_:convertTime12to24(`${$("#events_regis_time").val()}`)};if(happeningsDates&&happeningsDates.date){if($scope.happeningsDateList&&$scope.happeningsDateList.length){let dateObj=$scope.happeningsDateList.find(({date})=>date===happeningsDates.date);if(dateObj&&dateObj.date)toastMsg(!1,"Same date is already there. Please try again");else $scope.happeningsDateList.push(happeningsDates)}else $scope.happeningsDateList.push(happeningsDates);$("#datepicker_happen,#events_start_time,#events_end_time").val(null)}}else{if(!$("#events_start_time").val())
$("#happen-start-time-err").html('Start time is required!');if(!$("#events_end_time").val())
$("#happen-end-time-err").html('End time is required!');if(!$("#datepicker_happen").val())
$("#happen-date-err").html('Date is required!')}}
$scope.happeningsDateRemove=i=>$scope.happeningsDateList.splice(i,1);$scope.createEventHappenings=()=>{$(`#_happenings_title_error,#_happenings_category_Error,#_happenings_desc_Error,#__happenings_Prizes_Error
                #happen-date-err,#happen-regis-time-err,#happen-start-time-err,#happen-end-time-err`).html('');let title,fullDesc,dates,happeningsCategoryId,img,isTrue=!0,prizes,isTicketedEvent=!1,isSignUp=!1;create=()=>{Happenings.createAndUpdate({params:{title,fullDesc,dates,ownerId:$scope.userId,happeningsCategoryId,img,prizes,isTicketedEvent,isSignUp}}).$promise.then((res)=>{$("#_happenings_title,#_happenings_description").val(null);$scope.happeningsDateList=[];img=[];$(".event-tab-header").each(function(){$(this).removeClass('active')});$("#upload__btn__wrap_Happenings").html(null);$("#nav-happen-tickets").addClass('active').addClass('in');$("#nav-happen-details").removeClass('active').removeClass('in');$("#create-tickets").css('display','block');$("#create-new-tickets").css('display','none');$(".create-t-t").addClass('active');if(res&&res.data&&res.data.result)$("#finsihTicket_btn").attr('data-happeningsId',res.data.result.id);toastMsg(!0,"Successfully created!");loader.hidden()},(err)=>{toastMsg(!1,"Please try again!");loader.hidden()})}
uploadImg=()=>{return new Promise((resolve,reject)=>{var fd=new FormData();fd.append(`happenings_0`,$scope.happeningsImage[0].imgBlop,$scope.happeningsImage[0].imgName);$http.post('/happeningsImg',fd,{headers:{'Content-Type':undefined}}).then((res)=>{if(res&&res.data&&res.data.isSuccess){img=res.data.result;resolve({isSuccess:!0})}else loader.hidden()},()=>loader.hidden())})}
if(!$("#_happenings_title").val()){isTrue=!1;$("#_happenings_title_error").html('Title is required!')}
if(!$scope.happenings_category.id){isTrue=!1;$("#_happenings_category_Error").html('Category is required!')}
if(!$("#_happenings_description").val()){isTrue=!1;$("#_happenings_desc_Error").html('Description is required!')}
if(!$("#_happenings_Prizes").val()){isTrue=!1;$("#__happenings_Prizes_Error").html('Prizes is required!')}
if(!$("#datepicker_happen").val()){isTrue=!1;$("#happen-date-err").html('Date is required!')}
if(!$("#events_regis_time").val()){isTrue=!1;$("#happen-regis-time-err").html('Registration is required!')}
if(!$("#events_start_time").val()){isTrue=!1;$("#happen-start-time-err").html('Start time is required!')}
if(!$("#events_end_time").val()){isTrue=!1;$("#happen-end-time-err").html('End time is required!')}
if(isTrue){$scope.happeningsDateAdd();dates=$scope.happeningsDateList;fullDesc=$("#_happenings_description").val();title=$("#_happenings_title").val();happeningsCategoryId=$scope.happenings_category.id;prizes=$("#_happenings_Prizes").val();isSignUp=Boolean($('input[name=event-sign-up-r]:checked').val());isTicketedEvent=Boolean($('input[name=event-ticket-r]:checked').val());if($scope.happeningsImage&&$scope.happeningsImage.length){loader.visible();uploadImg().then((res)=>{create()})}else create()}};$scope.finishTicket=()=>{let ticketType,ticketName,qtyForSale,salePrice,saleFrom,saleFromTime,saleUntil,saleUntilTime,ticketDesc,absorbFees,ticketExpDate,ticketExpTime,minTicket,maxTicket,isTrue=!0;$(`#_ticket_name_Err,#_ticket_qty_sale_Err,#_ticket_price_Err,#_ticket_sale_from_Err,#_ticket_sale_time_Err,
                #_ticket_sale_until_date_err,#_ticket_sale_until_time_err,#_ticket_desc_err,#_ticket_exp_date_err,#_ticket_exp_time_err`).html(null);if(!$("#ticket_name").val()){isTrue=!1;$("#_ticket_name_Err").html("Ticket name is required!")}
if(!$("#_ticket_qty_sale").val()){isTrue=!1;$("#_ticket_qty_sale_Err").html("Quanity is required!")}
if(!$("#ticket_price").val()){isTrue=!1;$("#_ticket_price_Err").html("Price is required!")}
if(!$("#_ticket_sale_from").val()){isTrue=!1;$("#_ticket_sale_from_Err").html("Required!")}
if(!$("#_ticket_sale_time").val()){isTrue=!1;$("#_ticket_sale_time_Err").html("Required!")}
if(!$("#_ticket_sale_until_date").val()){isTrue=!1;$("#_ticket_sale_until_date_err").html("Required!")}
if(!$("#_ticket_sale_until_time").val()){isTrue=!1;$("#_ticket_sale_until_time_err").html("Required!")}
if(!$("#_ticket_desc").val()){isTrue=!1;$("#_ticket_desc_err").html("Description is Required!")}
if(!$("#_ticket_exp_date").val()){isTrue=!1;$("#_ticket_exp_date_err").html("Required!")}
if(!$("#_ticket_exp_time").val()){isTrue=!1;$("#_ticket_exp_time_err").html("Required!")}
if(isTrue){ticketType=$(".happenings-btn.active-happen").data('val');ticketName=$("#ticket_name").val();qtyForSale=$("#_ticket_qty_sale").val();salePrice=$("#ticket_price").val();saleFrom=`${$("#_ticket_sale_from").val()}T00:00:00.000Z`;saleFromTime=$("#_ticket_sale_time").val();saleUntil=`${$("#_ticket_sale_until_date").val()}T00:00:00.000Z`;saleUntilTime=$("#_ticket_sale_until_time").val();ticketDesc=$("#_ticket_desc").val();absorbFees=$("#_absorb_fees").prop("checked");ticketExpDate=`${$("#_ticket_exp_date").val()}T00:00:00.000Z`;ticketExpTime=$("#_ticket_exp_time").val();minTicket=$("#ticket_min").val();maxTicket=$("#ticket_max").val();let happeningsId=$("#finsihTicket_btn").data('happeningsid');if(happeningsId){loader.visible();HappeningsTicket.createAndUpdate({params:{happeningsId,ticketType,ticketName,qtyForSale,salePrice,saleFrom,saleFromTime,saleUntil,saleUntilTime,ticketDesc,absorbFees,ticketExpDate,ticketExpTime,minTicket,maxTicket}}).$promise.then((res)=>{$(`#ticket_name,#_ticket_qty_sale,#ticket_price,#_ticket_sale_from,#_ticket_sale_time,#_ticket_sale_until_date,
                                #_ticket_sale_until_time,#_ticket_sale_until_date,#_ticket_sale_until_time,#_ticket_desc,#_absorb_fees,
                                #_ticket_exp_date,#_ticket_exp_time,#ticket_min,#ticket_max`).val(null);toastMsg(!0,'Successfully created');$("#finsihTicket_btn").data('happeningsid','');loader.hidden();$("#create-tickets").css('display','block');$("#create-new-tickets,#no-img-div,#ticket-list").css('display','none');$scope.getAllTickets()},(err)=>{toastMsg(!1,'Please try again!');loader.hidden()})}else toastMsg(!1,'Please create a happenings!')}}}]).controller('happeningsManageCtl',['$scope','$state','Business','$http','$rootScope','HappeningsCategory','Happenings','loader',function($scope,$state,Business,$http,$rootScope,HappeningsCategory,Happenings,loader){if($rootScope.currentUser&&$rootScope.currentUser.email){$scope.useremail=$rootScope.currentUser.email}else $state.go('logout');toastMsg=(isVaild,msg)=>{if(isVaild)
toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
$scope.happeningsDataList=[];filterToday=(res=[])=>{$scope.happeningsDataList=[];res.forEach((val,i)=>{if(val.happeningsDates&&val.happeningsDates.length){val.happeningsDates.forEach((dates,j)=>{if(dates.dateFormat){$scope.happeningsDataList.push(val)}
if((i+1)==res.length&&val.happeningsDates.length==(j+1))loader.hidden()})}})}
$scope.getAllHappenings=()=>{loader.visible();Happenings.find({filter:{where:{ownerId:$scope.userId},include:[{relation:"happeningsDates"},{relation:"happeningsCategory"}]}}).$promise.then((res)=>{if(res&&res.length)filterToday(res);else{$scope.happeningsDataList=[];loader.hidden()}},()=>{loader.hidden()})};$scope.isBusinessSelect=!1;$scope.userId="";if(!$scope.userId){$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email}
if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;if($rootScope.selectedVenue){Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res});$scope.userId=$rootScope.selectedVenue.venueId;$("#autocompleteBusiness").val($rootScope.selectedVenue.venueName);$("#autocompleteBusiness").data('id',$rootScope.selectedVenue.venueId);$scope.getAllHappenings();$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}else{Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}}
else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
$scope.getBusinessName=()=>{return $scope.businessDelection};$scope.happeningsCategory=[];$scope.getHappeningscategory=()=>{HappeningsCategory.find({filter:{where:{ownerId:$scope.userId}}}).$promise.then((res)=>{$scope.happeningsCategory=res.filter(m=>m._name!='addnew');$scope.happeningsCategory.push(res.find(m=>m._name=='addnew'))})}
$scope.getHappeningscategory();$scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg&&arg=='manageEvent'){if($("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg;$rootScope.selectedVenue={venueId:$scope.userId,venueName:$("#autocompleteBusiness").val()}
$scope.getHappeningscategory();$scope.getAllHappenings()}}else $("#businessErr").text('Please select the Business name')}}
$scope.delete=(id)=>{if(id){$("#confirmDeleteBtn").attr('data-id',id);$("#deleteConfirmPopup").modal({backdrop:'static',keyboard:!1})}else toastMsg(!1,'Please try again!')};$scope.confirmDelete=()=>{let id=$("#confirmDeleteBtn").data('id');if(id){loader.visible();$("#deleteConfirmPopup").modal('hide');Happenings.removeHappenings({params:{id}}).$promise.then((res)=>{$scope.getAllHappenings();toastMsg(!0,'Successfully deleted!')},()=>{loader.hidden()})}else toastMsg(!1,'Please try again!')}}]).controller('happeningsEditCtl',['$scope','$state','Business','$http','$rootScope','HappeningsCategory','Happenings','loader','$stateParams','HappeningsDate',function($scope,$state,Business,$http,$rootScope,HappeningsCategory,Happenings,loader,$stateParams,HappeningsDate){if($rootScope.currentUser&&$rootScope.currentUser.email){$scope.useremail=$rootScope.currentUser.email}else $state.go('logout');toastMsg=(isVaild,msg)=>{if(isVaild)
toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
const convertTime12to24=(time12h)=>{const[time,modifier]=time12h.split(' ');let[hours,minutes]=time.split(':');if(hours==='12'){hours='00'}
if(modifier==='PM'){hours=parseInt(hours,10)+12}
return `${hours}:${minutes}`}
function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
byteString=atob(dataURI.split(',')[1]);else byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
return new Blob([ia],{type:mimeString})};if($stateParams.id&&$stateParams.ownerId){loader.visible();HappeningsCategory.find({filter:{where:{ownerId:$stateParams.ownerId}}}).$promise.then((res)=>{$scope.happeningsCategory=res;Happenings.findOne({filter:{where:{id:$stateParams.id},include:[{relation:"happeningsDates"}]}}).$promise.then((happenings)=>{$scope.happenings=happenings;if(res&&res.length)
$scope.Category=(res.find(m=>m.id==happenings.happeningsCategoryId)).name;setTimeout(function(){loader.hidden()},100)},()=>{loader.hidden()})},()=>{loader.hidden()})}
else $state.go('happenings');$scope.happeningsDateRemove=(i)=>{let datesObj=$scope.happenings.happeningsDates[i];$scope.happenings.happeningsDates.splice(i,1);if(datesObj&&datesObj.id)HappeningsDate.deleteById({id:datesObj.id});toastMsg(!0,'Successfully deleted')};$scope.happenings_category={};$scope.happingsChange=(event)=>{if(event=='Add New')$('#addNewcategoryEntertain').modal({backdrop:'static',keyboard:!1});HappeningsCategory.findOne({filter:{where:{ownerId:$stateParams.ownerId,name:event}}}).$promise.then((res)=>{$scope.happenings_category=res})};$scope.updateHappenings=(id)=>{let img=[];update=(arg)=>{Happenings.upsertWithWhere({where:{id}},arg).$promise.then((res)=>{for(let obj of $scope.happeningsDateList){let{date,startTime,endTime,startDateUTC,endDateUTC,dateNo,month,year,dateFormat}=obj;HappeningsDate.create({happeningsId:id,date,startTime,endTime,startDateUTC,endDateUTC,dateNo,month,year,dateFormat})}
loader.hidden();toastMsg(!0,'Successfully updated')})}
uploadImg=()=>{return new Promise((resolve,reject)=>{var fd=new FormData();fd.append(`happenings`,$scope.happeningsImage[0].imgBlop,$scope.happeningsImage[0].imgName);$http.post('/happeningsImg',fd,{headers:{'Content-Type':undefined}}).then((res)=>{if(res&&res.data&&res.data.isSuccess){img=res.data.result;resolve({isSuccess:!0})}else loader.hidden()},()=>loader.hidden())})}
let happeningsCategoryId=null;if($scope.happenings_category&&$scope.happenings_category.id){happeningsCategoryId=$scope.happenings_category.id}else{happeningsCategoryId=$scope.happenings.happeningsCategoryId}
let title=$("#_happenings_title").val(),fullDesc=$("#_happenings_description").val();if($scope.happeningsImage&&$scope.happeningsImage.length){loader.visible();uploadImg().then((res)=>{update({img,title,fullDesc,happeningsCategoryId})})}else{loader.visible();update({title,fullDesc,happeningsCategoryId})}}
$scope.deleteImage=(id,img)=>{if(img&&img.length&&id){$http.post('/spaceFileDelete',{fileName:img[0].fileName})
Happenings.upsertWithWhere({where:{id}},{img:[]});$scope.happenings.img=[]}};$scope.happeningsDateList=[];$scope.happeningsDateAdd=()=>{$scope.dateupdate=!0;$("#happenings-start-date-error,#happenings-start-time-error,#happenings-end-time-error").css({display:'none'});if($("#_happenings_start_time").val()&&$("#_happenings_end_time").val()&&$("#datepicker_happenings").val()){let convert_date=$("#datepicker_happenings").val().split('-');let date=$("#datepicker_happenings").val(),cdate=new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]}`),dateNo=((cdate.getDate())>=10)?(cdate.getDate()):'0'+(cdate.getDate()),month=((cdate.getMonth()+1)>=10)?(cdate.getMonth()+1):'0'+(cdate.getMonth()+1),year=cdate.getFullYear();let sTime=$("#_happenings_start_time").val().split(':'),eTime=$("#_happenings_end_time").val().split(':');let startTime_24=convertTime12to24(`${Number(sTime[0]).toString()}:${sTime[1]}`),endTime_24=convertTime12to24(`${Number(eTime[0]).toString()}:${eTime[1]}`);let happeningsDates={date,dateNo,month,year,startTime:$("#_happenings_start_time").val(),endTime:$("#_happenings_end_time").val(),startDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${startTime_24}:00`)).toISOString(),endDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${endTime_24}:00`)).toISOString(),dateFormat:`${year}-${month}-${dateNo}T00:00:00.000Z`};addDate=()=>{$scope.happenings.happeningsDates.push(happeningsDates);$scope.happeningsDateList.push(happeningsDates)}
if(happeningsDates&&happeningsDates.date){if($scope.happeningsDateList&&$scope.happeningsDateList.length){let dateObj=$scope.happeningsDateList.find(({date})=>date===happeningsDates.date);if(dateObj&&dateObj.date)toastMsg(!1,"Same date is already there. Please try again");else addDate()}else addDate();$("#datepicker_happenings,#_happenings_start_time,#_happenings_end_time").val(null)}}else{if(!$("#_happenings_start_time").val())
$("#happenings-start-date-error").css({display:'block'});if(!$("#_happenings_end_time").val())
$("#happenings-start-time-error").css({display:'block'});if(!$("#datepicker_happenings").val())
$("#happenings-end-time-error").css({display:'block'})}}
$scope.imageDetails={};$scope.getFilenameandType=(arg,e)=>{if(e.data('name')=="happenings"){$scope.imageDetails.ImageAddCrop='';$scope.imageDetails.ImageAddCrop=Math.random().toString(36).substring(2)+"_"+arg.replace(/ /g,"_")}};$scope.happeningsImage=[];$scope.imageconverttofile=(data)=>{$('#imageCropModal').modal('hide');if($(".action #btnCrop").data('name')==="happenings"){$scope.happeningsImage=[];$("#upload__btn__wrap_Happenings").html('');$(".container .imageBox").css('background-image','');$("#upload__btn__wrap_Happenings").append(`<img src=${data} style="height: 105px;margin-top: -21px;margin-left: -21px;object-fit: cover;" />`);$scope.happeningsImage.push({imgBlop:dataURItoBlob(data),imgName:$scope.imageDetails.ImageAddCrop})}}}]).controller('happeningsViewCtl',['$scope','$state','Business','$http','$rootScope','HappeningsCategory','Happenings','loader','$stateParams','HappeningsDate',function($scope,$state,Business,$http,$rootScope,HappeningsCategory,Happenings,loader,$stateParams,HappeningsDate){toastMsg=(isVaild,msg)=>{if(isVaild)
toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
$(".event-tab-header,.event-tab-content").each(function(){if($(this).hasClass('active'))$(this).removeClass('active');if($(this).hasClass('in'))$(this).removeClass('in')});$(".h-t-preview").addClass('active');$("#nav-happen-review").addClass('active in');$(".b-selection").css('display','none');if($stateParams.id){$scope.happenings={};Happenings.findOne({filter:{where:{id:$stateParams.id},include:[{relation:"happeningsDates",scope:{include:{relation:"happeningsTickets"}}}]}}).$promise.then((res)=>{console.log(JSON.stringify(res));if(res)$scope.happenings=res;else $scope.happenings={}})}else $state.go('happenings');$scope.changeTheStatus=()=>{if($stateParams.id){loader.visible();Happenings.upsertWithWhere({where:{id:$stateParams.id}},{status:'LIVE'}).$promise.then((res)=>{toastMsg(!0,'Successfully updated!');$state.go('happenings');loader.hidden()},(err)=>{toastMsg(!1,'Please try again')})}else{toastMsg(!1,'Please try again!')}}}])