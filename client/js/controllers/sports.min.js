angular.module('app').controller('ManageSportsCtl',['$scope','$state','$rootScope','Business','$http','Sports','loader',function($scope,$state,$rootScope,Business,$http,Sports,loader){toastMsg=(isVaild,msg)=>{if(isVaild)
    toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
    $scope.isBusinessSelect=!1;if(!$scope.userId)$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email;$scope.userId="";if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}
    else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
    $scope.getBusinessName=()=>{return $scope.businessDelection};$scope.sportsDataList=[];$scope.getSports=()=>{loader.visible();Sports.find({filter:{where:{ownerId:$scope.userId},include:[{relation:"sportsDates"},{relation:"sportsCategory"}]}}).$promise.then((res)=>{$scope.sportsDataList=res;loader.hidden()},(err)=>{loader.hidden()})}
    $scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg){if(arg=='manageEvent'){if($("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
    if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg;$rootScope.selectedVenue={venueId:$scope.userId,venueName:$("#autocompleteBusiness").val()}
    $scope.getSports()}}else{$("#businessErr").text('Please select the Business name')}}}}
    $scope.deleteId=null;$scope.delete=(id)=>{$scope.deleteId=id;if(id){$("#deleteConfirmPopup").modal({backdrop:'static',keyboard:!1})}else toastMsg(!1,'Please try again!')};$scope.confirmDelete=()=>{let id=$scope.deleteId;if(id){loader.visible();$("#deleteConfirmPopup").modal('hide');Sports.findOne({filter:{where:{id}}}).$promise.then((sportsRes)=>{$http.post('/spaceFileDelete',{fileName:sportsRes.img[0].fileName});Sports.removeSports({params:{id}}).$promise.then((res)=>{$scope.getSports();toastMsg(!0,'Successfully deleted!')},()=>{loader.hidden()})},()=>{loader.hidden();toastMsg(!1,'Please try again!')})}else toastMsg(!1,'Please try again!')}}]).controller('CreateSportsCtl',['$scope','$state','$rootScope','Business','$http','SportsCategory','Sports','loader',function($scope,$state,$rootScope,Business,$http,SportsCategory,Sports,loader){toastMsg=(isVaild,msg)=>{if(isVaild)
    toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
    const convertTime12to24=(time12h)=>{const[time,modifier]=time12h.split(' ');let[hours,minutes]=time.split(':');if(hours==='12'){hours='00'}
    if(modifier==='PM'){hours=parseInt(hours,10)+12}
    return `${hours}:${minutes}`}
    function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
    byteString=atob(dataURI.split(',')[1]);else byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
    return new Blob([ia],{type:mimeString})};$scope.isBusinessSelect=!1;if(!$scope.userId)$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email;$scope.userId="";if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}
    else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
    $scope.getBusinessName=()=>{return $scope.businessDelection};$scope.SportsCategoryList=[],$scope.parentCategory=[];$scope.SportsCategory=()=>{SportsCategory.find().$promise.then((res)=>{$scope.parentCategory=res;$scope.SportsCategoryList=res.filter(m=>m.group=='Sports');$scope.SportsCategoryList.push({name:'Add New',_name:'Add_New',group:'Sports'})})}
    $scope.SportsCategory();$scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg){if(arg=='manageEvent'){if($("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
    if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg;$rootScope.selectedVenue={venueId:$scope.userId,venueName:$("#autocompleteBusiness").val()}
    $scope.SportsCategory()}}else{$("#businessErr").text('Please select the Business name')}}}}
    $scope.imageDetails={};$scope.getFilenameandType=(arg,e)=>{if(e.data('name')=="sports"){$scope.imageDetails.ImageAddCrop='';$scope.imageDetails.ImageAddCrop=Math.random().toString(36).substring(2)+"_"+arg.replace(/ /g,"_")}};$scope.uploadImages=[];$scope.imageconverttofile=(data)=>{$('#imageCropModal').modal('hide');if($(".action #btnCrop").data('name')==="sports"){$scope.uploadImages=[];$("#upload__btn__wrap_Sports").html('');$(".container .imageBox").css('background-image','');$("#upload__btn__wrap_Sports").append(`<img src=${data} style="height: 105px;margin-top: -21px;margin-left: -21px;object-fit: cover;" />`);$scope.uploadImages.push({imgBlop:dataURItoBlob(data),imgName:$scope.imageDetails.ImageAddCrop})}};$scope.sports_category={};$scope.sportsChange=(event)=>{$("#label_add_new_category").html('Add New Category');if(event&&event._name=='nrl'||event&&event._name=='afl'||event&&event._name=='rugby'){$(".selectTeam").css({display:'block'})}
    else{$(".selectTeam").css({display:'none'})}
    $("#_add_new_category").val(null);if(event&&event._name=='Add_New')$('#addNewcategory').modal({backdrop:'static',keyboard:!1});$scope.sports_category=event};$scope.teams=[];$scope.teamChange=(event)=>{SportsCategory.find().$promise.then((res)=>{if(event&&event._name=='nrl'){$scope.teams=res.filter(m=>m.group=='NRlTeam')}
    else if(event&&event._name=='afl'){$scope.teams=res.filter(m=>m.group=='AFLTeam')}
    else if(event&&event._name=='rugby'){$scope.teams=res.filter(m=>m.group=='RugbyTeam')}
    $scope.teams.push({name:'Add New',_name:'Add_New'})})};$scope.teamA={},$scope.teamB={};$scope.teamSelect=(team,type)=>{$("#label_add_new_category").html('Add New Team');if(team&&team._name=='Add_New')$('#addNewcategory').modal({backdrop:'static',keyboard:!1});if(type=='A')$scope.teamA=team;if(type=='B')$scope.teamB=team}
    $scope.CategorySaveBtn=()=>{let name=$("#_add_new_category").val();$("#_add_new_category_err").html('');if(name){let _name=($.trim(name)).toLowerCase();if($("#label_add_new_category").html()=='Add New Category'){SportsCategory.upsertWithWhere({where:{name,_name,group:'Sports'}},{name,_name,group:'Sports'}).$promise.then(()=>{$scope.SportsCategory()})}else if($("#label_add_new_category").html()=='Add New Team'){let group='';if($scope.sports_category._name=='nrl')group='NRlTeam';else if($scope.sports_category._name=='afl')group='AFLTeam';else if($scope.sports_category._name=='rugby')group='RugbyTeam';SportsCategory.upsertWithWhere({where:{name,_name,group}},{name,_name,group}).$promise.then(()=>{$scope.teamChange($scope.sports_category)})}
    $('#addNewcategory').modal('hide');toastMsg(!0,"Successfully created!")}else if(!name)$("#_add_new_category_err").html('Please enter the category!')};$scope.sportsDateList=[];$scope.sportsDateAdd=()=>{$("#happenings-start-date-error,#happenings-start-time-error,#happenings-end-time-error").css({display:'none'});if($("#_sports_start_time").val()&&$("#_sports_end_time").val()&&$("#datepicker_sports").val()){let convert_date=$("#datepicker_sports").val().split('-');let date=$("#datepicker_sports").val(),cdate=new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]}`),dateNo=((cdate.getDate())>=10)?(cdate.getDate()):'0'+(cdate.getDate()),month=((cdate.getMonth()+1)>=10)?(cdate.getMonth()+1):'0'+(cdate.getMonth()+1),year=cdate.getFullYear();let sTime=$("#_sports_start_time").val().split(':'),eTime=$("#_sports_end_time").val().split(':');let startTime_24=convertTime12to24(`${Number(sTime[0]).toString()}:${sTime[1]}`),endTime_24=convertTime12to24(`${Number(eTime[0]).toString()}:${eTime[1]}`);let sportsDates={date,dateNo,month,year,startTime:$("#_sports_start_time").val(),endTime:$("#_sports_end_time").val(),startDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${startTime_24}:00`)).toISOString(),endDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${endTime_24}:00`)).toISOString(),dateFormat:`${year}-${month}-${dateNo}T00:00:00.000Z`};if(sportsDates&&sportsDates.date){if($scope.sportsDateList&&$scope.sportsDateList.length){let dateObj=$scope.sportsDateList.find(({date})=>date===sportsDates.date);if(dateObj&&dateObj.date)toastMsg(!1,"Same date is already there. Please try again");else $scope.sportsDateList.push(sportsDates)}else $scope.sportsDateList.push(sportsDates);$("#datepicker_sports,#_sports_start_time,#_sports_end_time").val(null)}}else{if(!$("#_sports_start_time").val())
    $("#sports-start-date-error").css({display:'block'});if(!$("#_sports_end_time").val())
    $("#sports-start-time-error").css({display:'block'});if(!$("#datepicker_sports").val())
    $("#ports-end-time-error").css({display:'block'})}}
    $scope.sportsDateRemove=i=>$scope.sportsDateList.splice(i,1);$scope.createSports=()=>{let isTrue=!0,img=[];$("#_sports_title_error,#_sports_category_Error,#_sports_description_Error").css({display:'none'});uploadImg=()=>{return new Promise((resolve,reject)=>{var fd=new FormData();fd.append(`sports`,$scope.uploadImages[0].imgBlop,$scope.uploadImages[0].imgName);$http.post('/happenings',fd,{headers:{'Content-Type':undefined}}).then((res)=>{if(res&&res.data&&res.data.isSuccess){img=res.data.result;resolve({isSuccess:!0})}else loader.hidden()},()=>loader.hidden())})}
    sCreate=()=>{let title=$("#_sports_title").val(),fullDesc=$("#_sports_description").val(),sportsCategoryId=$scope.sports_category.id,teamA=null,_teamA=null,teamB=null,_teamB=null;if($scope.teamA&&$scope.teamA.name)teamA=$scope.teamA.name;if($scope.teamA&&$scope.teamA._name)_teamA=$scope.teamA._name;if($scope.teamB&&$scope.teamB.name)teamB=$scope.teamB.name;if($scope.teamB&&$scope.teamB._name)_teamB=$scope.teamB._name;Sports.createAndUpdate({params:{ownerId:$scope.userId,img,title,fullDesc,sportsCategoryId,teamA,_teamA,teamB,_teamB,dates:$scope.sportsDateList}}).$promise.then((res)=>{if(res.data.isSuccess){toastMsg(!0,'Successfully created!');$("#_sports_title,#_sports_description").val(null);$("#upload__btn__wrap_Sports").html('');$scope.sportsDateList=[];$scope.teamChange($scope.sports_category);$scope.sports_category={};$scope.SportsCategory()}
    else toastMsg(!1,'Please try again');loader.hidden()},(err)=>{toastMsg(!1,'Please try again');loader.hidden()})}
    if($("#businessSubmit").hasClass('businessReset')){if(!$("#_sports_title").val()){isTrue=!1;$("#_sports_title_error").css({display:'block'})}
    if(!$scope.sports_category.id){$("#_sports_category_Error").css({display:'block'});isTrue=!1}
    if(!$("#_sports_description").val()){$("#_sports_description_Error").css({display:'block'});isTrue=!1}
    if(!$scope.sportsDateList.length){toastMsg(!1,"Please add the date!");isTrue=!1}
    if($scope.sports_category&&$scope.sports_category._name){if($scope.sports_category._name=='nrl'||$scope.sports_category._name=='afl'||$scope.sports_category._name=='rugby'){if(!$scope.teamA.hasOwnProperty('name')){$("#_sports_team_A_Error").css({display:'block'});isTrue=!1}
    if(!$scope.teamB.hasOwnProperty('name')){$("#_sports_team_B_Error").css({display:'block'});isTrue=!1}}}
    if(isTrue){loader.visible();if($scope.uploadImages&&$scope.uploadImages.length){uploadImg().then(()=>{sCreate()})}else sCreate()}}else toastMsg(!1,'Please select the Business!')}}]).controller('EditSportsCtl',['$scope','$state','$rootScope','Business','$http','Sports','loader','$stateParams','SportsCategory','SportsDate',function($scope,$state,$rootScope,Business,$http,Sports,loader,$stateParams,SportsCategory,SportsDate){toastMsg=(isVaild,msg)=>{if(isVaild)
    toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
    const convertTime12to24=(time12h)=>{const[time,modifier]=time12h.split(' ');let[hours,minutes]=time.split(':');if(hours==='12'){hours='00'}
    if(modifier==='PM'){hours=parseInt(hours,10)+12}
    return `${hours}:${minutes}`}
    function dataURItoBlob(dataURI){var byteString;if(dataURI.split(',')[0].indexOf('base64')>=0)
    byteString=atob(dataURI.split(',')[1]);else byteString=unescape(dataURI.split(',')[1]);var mimeString=dataURI.split(',')[0].split(':')[1].split(';')[0];var ia=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){ia[i]=byteString.charCodeAt(i)}
    return new Blob([ia],{type:mimeString})};$scope.SportsCategoryList=[],$scope.parentCategory=[];$scope.SportsCategory=()=>{SportsCategory.find().$promise.then((res)=>{$scope.parentCategory=res;$scope.SportsCategoryList=res.filter(m=>m.group=='Sports');$scope.SportsCategoryList.push({name:'Add New',_name:'Add_New',group:'Sports'})})}
    $scope.SportsCategory();if($stateParams.id&&$stateParams.ownerId){Sports.findOne({filter:{where:{id:$stateParams.id},include:[{relation:"sportsDates"}]}}).$promise.then((res)=>{$scope.sportsRes=res})}
    $scope.deleteImage=(id,img)=>{if(img&&img.length&&id){$http.post('/spaceFileDelete',{fileName:img[0].fileName})
    Sports.upsertWithWhere({where:{id}},{img:[]});$scope.sportsRes.img=[]}};$scope.imageDetails={};$scope.getFilenameandType=(arg,e)=>{if(e.data('name')=="sports"){$scope.imageDetails.ImageAddCrop='';$scope.imageDetails.ImageAddCrop=Math.random().toString(36).substring(2)+"_"+arg.replace(/ /g,"_")}};$scope.uploadImages=[];$scope.imageconverttofile=(data)=>{$('#imageCropModal').modal('hide');if($(".action #btnCrop").data('name')==="sports"){$scope.uploadImages=[];$("#upload__btn__wrap_Sports").html('');$(".container .imageBox").css('background-image','');$("#upload__btn__wrap_Sports").append(`<img src=${data} style="height: 105px;margin-top: -21px;margin-left: -21px;object-fit: cover;" />`);$scope.uploadImages.push({imgBlop:dataURItoBlob(data),imgName:$scope.imageDetails.ImageAddCrop})}};$scope.uploadSports=(id)=>{let img=[];update=(arg)=>{Sports.upsertWithWhere({where:{id}},arg).$promise.then((res)=>{for(let obj of $scope.sportsDateList){let{date,startTime,endTime,startDateUTC,endDateUTC,dateNo,month,year,dateFormat}=obj;SportsDate.create({sportsId:id,date,startTime,endTime,startDateUTC,endDateUTC,dateNo,month,year,dateFormat})}
    loader.hidden();toastMsg(!0,'Successfully updated')})}
    uploadImg=()=>{return new Promise((resolve,reject)=>{var fd=new FormData();fd.append(`sports_0`,$scope.uploadImages[0].imgBlop,$scope.uploadImages[0].imgName);$http.post('/happenings',fd,{headers:{'Content-Type':undefined}}).then((res)=>{if(res&&res.data&&res.data.isSuccess){img=res.data.result;resolve({isSuccess:!0})}else loader.hidden()},()=>loader.hidden())})}
    let title=$("#_sports_title").val(),fullDesc=$("#_sports_description").val();if($scope.uploadImages&&$scope.uploadImages.length){loader.visible();uploadImg().then((res)=>{update({img,title,fullDesc})})}else{loader.visible();update({title,fullDesc})}}
    $scope.sportsDateList=[];$scope.sportsDateAdd=()=>{$("#happenings-start-date-error,#happenings-start-time-error,#happenings-end-time-error").css({display:'none'});if($("#_sports_start_time").val()&&$("#_sports_end_time").val()&&$("#datepicker_sports").val()){let convert_date=$("#datepicker_sports").val().split('-');let date=$("#datepicker_sports").val(),cdate=new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]}`),dateNo=((cdate.getDate())>=10)?(cdate.getDate()):'0'+(cdate.getDate()),month=((cdate.getMonth()+1)>=10)?(cdate.getMonth()+1):'0'+(cdate.getMonth()+1),year=cdate.getFullYear();let sTime=$("#_sports_start_time").val().split(':'),eTime=$("#_sports_end_time").val().split(':');let startTime_24=convertTime12to24(`${Number(sTime[0]).toString()}:${sTime[1]}`),endTime_24=convertTime12to24(`${Number(eTime[0]).toString()}:${eTime[1]}`);let sportsDates={date,dateNo,month,year,startTime:$("#_sports_start_time").val(),endTime:$("#_sports_end_time").val(),startDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${startTime_24}:00`)).toISOString(),endDateUTC:(new Date(`${convert_date[2]}-${convert_date[1]}-${convert_date[0]} ${endTime_24}:00`)).toISOString(),dateFormat:`${year}-${month}-${dateNo}T00:00:00.000Z`};if(sportsDates&&sportsDates.date){if($scope.sportsDateList&&$scope.sportsDateList.length){let dateObj=$scope.sportsDateList.find(({date})=>date===sportsDates.date);if(dateObj&&dateObj.date)toastMsg(!1,"Same date is already there. Please try again");else{$scope.sportsRes.sportsDates.push(sportsDates);$scope.sportsDateList.push(sportsDates)}}else{$scope.sportsRes.sportsDates.push(sportsDates);$scope.sportsDateList.push(sportsDates)}
    $("#datepicker_sports,#_sports_start_time,#_sports_end_time").val(null)}}else{if(!$("#_sports_start_time").val())
    $("#sports-start-date-error").css({display:'block'});if(!$("#_sports_end_time").val())
    $("#sports-start-time-error").css({display:'block'});if(!$("#datepicker_sports").val())
    $("#ports-end-time-error").css({display:'block'})}}
    $scope.sportsDateRemove=i=>$scope.sportsRes.sportsDates.splice(i,1)}]).controller('ViewSportsCtl',['$scope','$state','$rootScope','Business','$http','Sports','loader','$stateParams','SportsCategory',function($scope,$state,$rootScope,Business,$http,Sports,loader,$stateParams,SportsCategory){if($stateParams.id&&$stateParams.ownerId){loader.visible();SportsCategory.find().$promise.then((res)=>{$scope.sportsCategory=res.filter(m=>m.group=='Sports');Sports.findOne({filter:{where:{id:$stateParams.id},include:[{relation:"sportsDates"}]}}).$promise.then((sportsRes)=>{$scope.sports=sportsRes;let cateG=res.find(m=>m.id==sportsRes.sportsCategoryId);$scope.Category=(cateG&&cateG.name?cateG.name:'');setTimeout(function(){loader.hidden()},100)},()=>{loader.hidden()})},()=>{loader.hidden()})}
    else $state.go('sports')}])