angular.module('app').controller('whatsonCtl',['$scope','$state','$rootScope','Business','$http','WhatsonCategory','WhatsOn',function($scope,$state,$rootScope,Business,$http,WhatsonCategory,WhatsOn){toastMsg=(isVaild,msg)=>{if(isVaild)
    toastr.success(msg);else toastr.error(msg);toastr.options={"closeButton":!0,"progressBar":!0,"timeOut":"5000"}}
    $scope.isBusinessSelect=!1;if(!$scope.userId)$scope.userId=$rootScope.currentUser.id;$scope.useremail=$rootScope.currentUser.email;$scope.userId="";if($rootScope&&$rootScope.currentUser&&$rootScope.currentUser.email=="admin@barm8.com.au"){$scope.isBusinessSelect=!0;Business.find({filter:{where:{status:"approved"},"fields":["businessName","id","email"]}}).$promise.then((res)=>{$scope.businessDelection=res;$scope.userId=$rootScope.currentUser.id},(err)=>{console.log(JSON.stringify())})}
    else{$scope.isBusinessSelect=!0;$scope.userId=$rootScope.currentUser.id}
    $scope.getBusinessName=()=>{return $scope.businessDelection};$scope.whatsonEat=$scope.whatsonDrinks=$scope.whatsonHappiness=$scope.whatsonFoodMenu=$scope.whatsonDrinksMenu=[];$scope.getWhatsOn=()=>{WhatsonCategory.find({filter:{where:{ownerId:$scope.userId},include:[{relation:"whatsOns",scope:{order:"isCreate desc"}}]}}).$promise.then((res)=>{if(res&&res.length){$scope.whatsonEat=res.find((m)=>m._category=="eat");$scope.whatsonEat=($scope.whatsonEat?($scope.whatsonEat).whatsOns:[]);$scope.whatsonDrinks=res.find((m)=>m._category=="drinks");$scope.whatsonDrinks=($scope.whatsonDrinks?($scope.whatsonDrinks).whatsOns:[]);$scope.whatsonHappiness=res.find((m)=>m._category=="happiness");$scope.whatsonHappiness=($scope.whatsonHappiness?($scope.whatsonHappiness).whatsOns:[]);$scope.whatsonFoodMenu=res.find((m)=>m._category=="foodMenu");$scope.whatsonFoodMenu=($scope.whatsonFoodMenu?($scope.whatsonFoodMenu).whatsOns:[]);$scope.whatsonDrinksMenu=res.find((m)=>m._category=="drinksMenu");$scope.whatsonDrinksMenu=($scope.whatsonDrinksMenu?($scope.whatsonDrinksMenu).whatsOns:[])}})};$scope.BusinessSelected=(arg)=>{$("#businessErr").text('');if(arg){if(arg=='manageEvent'){if($("#autocompleteBusiness").data('id')){arg=$("#autocompleteBusiness").data('id');if($("#businessSubmit").hasClass('businessSubmit')){$("#businessSubmit").html('<i class="fa fa-check" aria-hidden="true"></i>&nbsp;&nbsp;Reset').removeClass('businessSubmit').addClass('businessReset')}
    if(arg!="select"){$scope.isBusinessSelect=!0;$scope.userId=arg;$rootScope.selectedVenue={venueId:$scope.userId,venueName:$("#autocompleteBusiness").val()}
    $scope.getWhatsOn()}}else{$("#businessErr").text('Please select the Business name')}}}}
    String.prototype.toCamelCase=function(){return this.replace(/^([A-Z])|\s(\w)/g,function(match,p1,p2,offset){if(p2)return p2.toUpperCase();return p1.toLowerCase()})};$scope.uploadImage=(files)=>{if($("#businessSubmit").hasClass('businessReset')){let category=_category=null;$(".whatson-tab-header.active").each(function(){category=$(this).data('category');_category=($.trim(category)).toCamelCase()})
    var fd=new FormData();for(let index in files)fd.append(`whatson_${index}`,files[index]);$("#whatsImageSave").html('<i class="fas fa-spinner fa-spin"></i> Upload').prop('disabled',!0);$("#whatsonCtl").css({"opacity":"0.1"});$http.post('/whatson',fd,{headers:{'Content-Type':undefined}}).then((res)=>{if(res.data.isSuccess&&res.data.result){WhatsonCategory.createAndUpdate({params:{ownerId:$scope.userId,category,_category,files:res.data.result}}).$promise.then((res)=>{$("#whatsImageSave").html('<i class="fas fa-cloud-upload-alt"></i> Upload').prop('disabled',!1);setTimeout(function(){$("#whatsonCtl").css({"opacity":""})},2500);toastMsg(!0,"Successfully updated");setTimeout(function(){$scope.getWhatsOn()},2000)})}})}else toastMsg(!1,"Please select the Business!")};$scope.delete=(id)=>{$(`#delete_${id}`).html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled',!0);if(id){WhatsOn.findOne({filter:{where:{id}}}).$promise.then((res)=>{if(res&&res.fileName){$http.post('/spaceFileDelete',{fileName:res.fileName}).then((deleteImg)=>{WhatsOn.destroyById({id:res.id}).$promise.then(()=>{$scope.getWhatsOn()});toastMsg(!0,"Successfully deleted!");setTimeout(function(){$(`#delete_${id}`).html('<i class="far fa-trash-alt"></i>').prop('disabled',!1)},1500)})}else{toastMsg(!1,"Please try again!");$(`#delete_${id}`).html('<i class="far fa-trash-alt"></i>').prop('disabled',!1)}})}else toastMsg(!1,"Please try again!")}}])